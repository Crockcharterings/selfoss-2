<html><head><title>Facebook存储进阶路：NoSQL Pattern的入门介绍</title></head><body><style type='text/css'>img{display:block;margin:0 auto;}p{font-size: 28px;}</style><img src="https://pic1.zhimg.com/bb6ce05eeacfeba688b99541f3c27198_b.jpg" width="640" alt="image" /><p>Facebook&#20174;&#25104;&#31435;&#20043;&#21021;&#20316;&#20026;&#19968;&#20010;&#23567;&#22411;&#21306;&#22495;&#22411;&#31038;&#20132;&#32593;&#31449;&#65292;&#21040;&#22914;&#20170;&#28436;&#21464;&#25104;&#20026;&#20840;&#29699;&#26368;&#22823;&#30340;&#31038;&#20132;&#32593;&#31449;&#65292;&#26550;&#26500;&#32463;&#21382;&#20102;&#36807;&#20960;&#27425;&#37325;&#22823;&#30340;&#36845;&#20195;&#12290;&#20854;&#20013;&#65292;Facebook&#30340;&#23384;&#20648;&#20063;&#20174;&#20174;&#23567;&#21464;&#22823;&#65292;&#20174;&#21333;&#19968;&#21464;&#24471;&#26356;&#20855;&#26377;&#22810;&#26679;&#24615;&#65292;&#20174;&#32780;&#24212;&#23545;&#21508;&#31181;&#25299;&#23637;&#24615;&#38382;&#39064;&#12290;</p><br /><p>&#26412;&#25991;&#23558;&#39318;&#20808;&#20174;Facebook&#30340;&#21319;&#32423;&#36716;&#21464;&#24320;&#22987;&#65292;&#35848;&#21040;&#25968;&#25454;&#23384;&#20648;&#33021;&#21147;&#25552;&#21319;&#23545;&#20110;&#20844;&#21496;Scalability&#30340;&#24040;&#22823;&#24433;&#21709;&#65292;&#28982;&#21518;&#20171;&#32461;Facebook&#22312;Canssandra&#21644;Hbase&#20043;&#38388;&#30340;&#36873;&#25321;&#65292;&#20174;&#32780;&#24341;&#30003;&#20986;NoSQL&#23558;&#35201;&#35299;&#20915;&#30340;&#38382;&#39064;&#39046;&#22495;&#65292;&#26368;&#21518;&#38598;&#20013;&#20171;&#32461;&#20102;NoSQL Pattern&#30340;&#22522;&#26412;&#32452;&#25104;&#12290;&#24076;&#26395;&#33021;&#22312;&#30475;&#23436;&#25991;&#31456;&#20043;&#21518;&#65292;&#22823;&#23478;&#21487;&#20197;&#23545;NoSQL&#35201;&#35299;&#20915;&#30340;&#38382;&#39064;&#65292;NoSQL&#30340;&#22522;&#26412;&#26500;&#25104;&#65292;&#20197;&#21450;NoSQL&#23545;&#20110;Facebook&#36825;&#26679;&#22823;&#22411;&#20844;&#21496;&#30340;&#37325;&#35201;&#24615;&#26377;&#19968;&#23450;&#30340;&#35748;&#35782;&#12290;</p><h1>Facebook&#30340;&#25968;&#25454;&#23384;&#20648;&#36827;&#21270;</h1><p>&#23545;&#20110;Facebook&#22312;&#25968;&#25454;&#22788;&#29702;&#33021;&#21147;&#19978;&#30340;&#36827;&#21270;&#65292;&#21487;&#20197;&#20808;&#21015;&#20960;&#20010;&#25991;&#31456;&#26631;&#39064;&#26469;&#30452;&#35266;&#24863;&#21463;&#19968;&#19979;&#65306;</p><br /><ul><li><p><a href="https://link.zhihu.com/?target=http%3A//highscalability.com/blog/2008/5/14/new-facebook-chat-feature-scales-to-70-million-users-using-e.html">New Facebook Chat Feature Scales To 70 Million Users Using Erlang</a>, May 14, 2008.</p></li><li><p>Facebook's New Real&shy;time Messaging System: HBase to Store 135+Billion Messages a Month Nov 16, 2010.</p></li><li><p>Facebook's New Realtime Analytics System: HBase to Process 20 Billion Events Per Day Mar 22, 2011</p></li></ul><br /><p>&#31532;&#19968;&#31687;&#25991;&#31456;&#26159;&#21644;Chat&#21151;&#33021;&#30456;&#20851;&#65292;&#20027;&#35201;&#26159;&#35762;&#36890;&#36807;&#36873;&#29992;Erlang&#26469;&#22686;&#21152;Server&#31471;&#30340;&#22788;&#29702;&#33021;&#21147;&#12290;&#21518;&#20004;&#31687;&#35762;&#30340;&#37117;&#26159;&#22914;&#20309;&#39640;&#25928;&#12289;&#31283;&#23450;&#30340;&#23384;&#20648;&#22823;&#37327;&#25968;&#25454;&#26469;&#20026;Facebook&#30340;&#20854;&#20182;application&#26381;&#21153;&#12290;&#32780;&#20854;&#20013;&#21453;&#22797;&#20986;&#29616;&#30340;&#20851;&#38190;&#35789;&mdash;&mdash;Canssandra&#65292;HBase&#65292;&#23601;&#26159;&#35299;&#20915;Facebook&#38754;&#23545;&#22823;&#37327;&#25968;&#25454;&#26102;Scale&#30340;&#22522;&#30784;&#12290;</p><h1>Cassandra&#21644;HBase&#20026;&#20309;&#32780;&#29983;</h1><p>&#22914;&#26524;&#27604;&#36739;Canssandra&#21644;HBase&#65288;&#21487;&#21442;&#32771;<a href="https://link.zhihu.com/?target=http%3A//bit.ly/2akMsKo">http://bit.ly/2akMsKo</a>&#65289;&#20197;&#21450;&#20182;&#20204;&#30340;&#20849;&#21516;&#29305;&#28857;&#65292;&#23601;&#21487;&#20197;&#21457;&#29616;&#20182;&#20204;&#38750;&#24120;&#36866;&#21512;&#35299;&#20915;&#20197;&#19979;Scalability&#38382;&#39064;&#65306;</p><br /><ul><li><p>&#22914;&#20309;&#23454;&#29616;&#24212;&#29992;&#23618;&ldquo;&#26080;&#29366;&#24577;&rdquo;&#65311; &#20026;&#20102;&#35753;&#24212;&#29992;&#23618;&#21487;&#25299;&#23637;&#65292;&#38656;&#35201;&#20998;&#31163;&#25968;&#25454;&#23618;&#65292;&#23601;&#35201;&#35753;&#24212;&#29992;&#23618;&#22788;&#20110;&ldquo;&#26080;&#29366;&#24577;&rdquo;&#65292;&#20063;&#23601;&#26159;&#24212;&#29992;&#23618;&#19981;&#22240;&#20026;&#25968;&#25454;&#23618;&#30340;&#24433;&#21709;</p></li><li><p>&#25968;&#25454;&#23618;&#22914;&#20309;&#24310;&#20280;&#65311; &#36825;&#26159;&#21253;&#25324;Facebook&#24456;&#22810;&#20844;&#21496;&#20844;&#21496;&#37117;&#35201;&#38754;&#20020;&#30340;&#38382;&#39064;</p></li><li><p>&#22914;&#20309;&#23558;&#21512;&#36866;&#22320;&#21010;&#20998;&#25968;&#25454;&#22312;&#19981;&#21516;&#26426;&#22120;&#19978;&#65292;&#23454;&#29616;&#36127;&#36733;&#24179;&#34913;</p></li><li><p>&#25968;&#25454;&#22312;&#22810;&#20010;&#26426;&#22120;&#19978;&#65292;&#22914;&#20309;&#22788;&#29702;&#26426;&#22120;&#22351;&#25481;&#30340;&#24773;&#20917;&#65311;</p></li><li><p>&#22914;&#20309;&#22312;&#26426;&#22120;&#20043;&#38388;&#22791;&#20221;&#25968;&#25454;&#65311;</p></li><li><p>&#22312;&#25968;&#25454;&#22791;&#20221;&#30340;&#26102;&#20505;&#65292;&#22914;&#20309;&#20445;&#25345;&#21516;&#27493;&#21602;&#65311;</p></li><li><p>&#22914;&#20309;&#32467;&#21512;&#20113;&#35745;&#31639;&#65292;&#23454;&#29616;&#26381;&#21153;&#22120;&#25968;&#37327;&#30340;&#33258;&#21160;&#24310;&#20280;&#65311; &#20063;&#23601;&#26159;&#65292;&#20219;&#21153;&#37327;&#22823;&#30340;&#26102;&#20505;&#65292;&#23601;&#22686;&#21152;&#26426;&#22120;&#25968;&#37327;&#65292;&#20219;&#21153;&#37327;&#23569;&#30340;&#26102;&#20505;&#65292;&#23601;&#20943;&#23569;&#26426;&#22120;&#25968;&#37327;&#12290;</p></li><li><p>&#22240;&#20026;&#26426;&#22120;&#25968;&#37327;&#21487;&#21464;&#65292;&#24403;&#20219;&#21153;&#37327;&#21464;&#21270;&#23548;&#33268;&#26426;&#22120;&#25968;&#37327;&#21464;&#21270;&#30340;&#26102;&#20505;&#65292;&#21448;&#22914;&#20309;&#37325;&#26032;&#20998;&#37197;&#25968;&#25454;&#21602;&#65311;</p></li></ul><br /><p>&#20026;&#20102;&#35299;&#20915;&#36825;&#20123;Scalability&#38382;&#39064;&#65292;NoSQL&#20986;&#29616;&#20102;&#65292;&#23427;&#25104;&#20102;&#19968;&#31181;&#35299;&#20915;&#22823;&#22411;&#25968;&#25454;&#23384;&#20648;&#38382;&#39064;&#30340;&#24120;&#29992;&#26041;&#26696;&#65292;Canssandra &#21644; HBase&#23601;&#26159;&#26681;&#25454;NoSQL&#27010;&#24565;&#32780;&#24320;&#21457;&#20986;&#26469;&#30340;&#20855;&#20307;&#20135;&#21697;&#12290;</p><br /><p>&#20110;&#26159;&#65292;&#25105;&#20204;&#24819;&#35201;&#20102;&#35299;Facebook&#30340;&#26550;&#26500;&#30693;&#35782;&#65292;&#23601;&#32454;&#21270;&#25104;&#20102;&#20102;&#35299;Facebook&#22914;&#20309;&#22788;&#29702;&#22823;&#22411;&#25968;&#25454;&#65292;&#20877;&#32780;&#21464;&#25104;&#20026;Canssandra&#21644;Hbase&#22914;&#20309;&#22788;&#29702;&#25968;&#25454;&#65292;&#28982;&#21518;&#21464;&#25104;&#20026;&#65306;NoSQL&#36890;&#24120;&#24847;&#20041;&#19978;&#26159;&#22914;&#20309;&#35299;&#20915;Scalable&#25968;&#25454;&#23384;&#20648;&#38382;&#39064;&#30340;&#65281;</p><h1>NoSQL Pattern&#22522;&#26412;&#27010;&#24565;&#20171;&#32461;&#65288;&#24178;&#36135;&#65289;</h1><h2>&#24120;&#35265;NoSQL &#20135;&#21697;</h2><img src="https://pic2.zhimg.com/536ccd2417a76ab1044043f112d63a85_b.png" width="900" alt="image" /><p>&#19978;&#38754;&#26159;&#19977;&#22823;&#24040;&#22836;&#30456;&#23545;&#24212;&#30340;NoSQL&#35299;&#20915;&#26041;&#26696;&#65292;Google&#30340;Bigtable&#65292;&#36824;&#26377;Amazon&#30340;Dynamo&#21487;&#20197;&#21442;&#32771;&#36825;&#31687;&#25991;&#31456;&#65288;<a href="https://link.zhihu.com/?target=http%3A//bit.ly/29SEee6">http://bit.ly/29SEee6</a>&#65289;&#12290; Canssandra &#26159;&#31227;&#26893;&#20102;Dynamo&#30340;&#20998;&#24067;&#24335;&#35774;&#35745;&#65292;&#21152;&#19978;BigTable&#30340;&#25968;&#25454;&#27169;&#22411;&#32780;&#24320;&#21457;&#20986;&#26469;&#30340;&#12290;</p><p>&#36825;&#19977;&#31181;&#20135;&#21697;&#30340;&#20849;&#21516;&#28857;&#26159;&#65306;</p><ul><li><p>&#38190;-&#20540;&#23384;&#20648;</p></li><li><p>&#22823;&#37327;&#24265;&#20215;&#20027;&#26426;&#19978;&#36816;&#34892;</p></li><li><p>&#25968;&#25454;&#22312;&#36825;&#20123;&#20027;&#26426;&#20043;&#38388;&#20197;&#21010;&#20998;&#21644;&#22791;&#20221;&#30340;&#24418;&#24335;&#23384;&#20648;&#65288;&#20063;&#23601;&#26159;Partition&#21644;Replica&#65289;</p></li><li><p>&#30456;&#23545;&#36739;&#24369;&#30340;&#19968;&#33268;&#24615;&#35201;&#27714;&#65288;&#20851;&#20110;&#19968;&#33268;&#24615;&#30340;&#27010;&#24565;&#21487;&#20197;&#21442;&#32771;&#36825;&#20010;&#21098;&#30701;&#35828;&#26126;&#65306;<a href="https://link.zhihu.com/?target=http%3A//bit.ly/29SFPR0">http://bit.ly/29SFPR0</a>&#65289;</p></li></ul><h2>NoSQL &#21040;&#24213;&#26159;&#20160;&#20040;</h2><p>&#35828;&#20102;&#37027;&#20040;&#22810;&#65292; Facebook&#30340;&#25216;&#26415;&#19968;&#30452;&#30475;&#21040;Google&#65292;Amazon&#65292; NoSQL&#21040;&#24213;&#26159;&#24590;&#20040;&#22238;&#20107;&#65311;&#23427;&#30340;&#32467;&#26500;&#21644;&#20027;&#35201;&#25216;&#26415;&#26500;&#25104;&#30001;&#19979;&#22270;&#21487;&#20197;&#34920;&#31034;&#65306;</p><br /><img src="https://pic2.zhimg.com/e89a1dff98239fd43cb7b7d87762dda5_b.png" width="891" alt="image" /><h3>A. API Model (DB&#25805;&#20316;)</h3><p>&#23545;&#20110;&#25968;&#25454;&#24211;&#30340;&#24120;&#35265;&#25805;&#20316;&#65306;&#35835;&#12289;&#20889;&#12289;&#20462;&#25913;&#12290;</p><h3>B. NoSQL&#24213;&#23618;&#26550;&#26500;</h3><p>&#24213;&#23618;&#26550;&#26500;&#30001;&#19978;&#30334;&#25110;&#19978;&#21315;&#21488;&#35745;&#31639;&#26426;&#32452;&#25104;&#65292;&#27599;&#20010;&#35745;&#31639;&#26426;&#26159;&#19968;&#20010;&#29289;&#29702;&#33410;&#28857;&#65288;Physical Node&#65289;&#65292;&#36825;&#20123;&#29289;&#29702;&#33410;&#28857;&#30340;configuration&#65292;CPU&#65292; &#30828;&#30424;&#22823;&#23567;&#37117;&#19981;&#23613;&#30456;&#21516;&#12290;&#22312;&#27599;&#19968;&#20010;&#29289;&#29702;&#33410;&#28857;&#19978;&#65292;&#21448;&#21487;&#20197;&#20998;&#25104;&#33509;&#24178;&#20010;&#34394;&#25311;&#33410;&#28857;&#65288;Virtual Node&#65289;&#65306;</p><img src="https://pic4.zhimg.com/64346dc2d64249fbdbc236521fd51e23_b.png" width="522" alt="image" /><h3>C. Partition</h3><p>&#22240;&#20026;&#25972;&#20307;&#30340;hashtable&#26159;&#35201;&#20998;&#24067;&#22312;VNs &#19978;&#30340;&#65292;&#25152;&#20197;&#38656;&#35201;&#25214;&#21040;&#19968;&#20010;&#26041;&#27861;&#65292;&#25226;key&#21644;&#30456;&#24212;&#30340;VN&#32467;&#21512;&#36215;&#26469;&#12290;</p><h4>&#65288;1&#65289;partition = key mod (total_VN)</h4><p>&#36825;&#26679;&#30340;&#32570;&#28857;&#22312;&#20110;&#65292;&#22914;&#26524;VN&#30340;&#25968;&#37327;&#25913;&#21464;&#30340;&#35805;&#65292;&#20250;&#24341;&#36215;&#22823;&#37327;&#29616;&#23384;&#30340;key map&#25913;&#21464;&#65292;&#20174;&#32780;&#25152;&#26377;&#30340;&#25968;&#25454;&#37325;&#26032;&#20998;&#24067;&#65292;&#36825;&#26679;&#25928;&#29575;&#26174;&#28982;&#38750;&#24120;&#20302;&#12290;</p><h4>&#65288;2&#65289;Consistent Hashing</h4><p>&#36825;&#37324;&#30340;Key Space&#26159;&#26377;&#38480;&#22823;&#23567;&#30340;&#65292;&#19968;&#33324;&#26159;&#23558;0&#21040;2^32-1&#25968;&#23383;&#22836;&#23614;&#30456;&#36830;&#65292;&#23601;&#32467;&#21512;&#25104;&#19968;&#20010;&#38381;&#21512;&#30340;&#29615;&#24418;&#12290;&#23558;VN&#26144;&#23556;&#21040;&#29615;&#20013;&#65292;&#20197;&#39034;&#26102;&#38024;&#30340;&#26041;&#21521;&#35745;&#31639;&#65292;key&#30340;&#24402;&#23646;&#33410;&#28857;&#26159;&#23427;&#36935;&#21040;&#30340;&#31532;&#19968;&#20010;&#33410;&#28857;&#12290;</p><p>&#25152;&#20197;&#21482;&#26377;&#22312;&#30456;&#37051;&#33410;&#28857;&#23849;&#28291;&#30340;&#24773;&#20917;&#19979;&#65292;&#25968;&#25454;&#25165;&#20250;&#37325;&#26032;&#20998;&#24067;&#65292;&#20854;&#20182;&#25152;&#26377;key&#20381;&#28982;&#23384;&#22312;&#21508;&#33258;&#30340;VN&#20043;&#20013;&#12290; </p><h3>D. &#25968;&#25454;&#22797;&#21046;&#65288;Replica&#65289;</h3><p>&#22797;&#21046;&#25968;&#25454;&#30340;&#22909;&#22788;&#65306; </p><ul><li><p>&#25552;&#21319;&#21487;&#38752;&#24615;&#33021;</p></li><li><p>&#23558;&#24037;&#20316;&#37327;&#20998;&#25955;&#21040;&#26377;&#30456;&#21516;&#22791;&#20221;&#30340;&#20854;&#20182;&#33410;&#28857;&#19978;&#38754;&#65288;balance workload&#65289;</p></li></ul><h3>E. Node&#30340;&#21464;&#21270;&#65288;Membership Changes&#65289;</h3><p>&#20026;&#20102;&#21487;&#20197;&#26681;&#25454;workload&#22686;&#21024;&#33410;&#28857;&#65292;&#20351;&#36164;&#28304;&#21033;&#29992;&#25928;&#29575;&#26368;&#22823;&#65292;&#25110;&#32773;&#26159;&#22240;&#20026;&#33410;&#28857;&#38169;&#35823;&#32780;&#23548;&#33268;crash&#65292;&#36825;&#20123;&#24773;&#20917;&#19979;&#37117;&#38656;&#35201;&#26681;&#25454;Consitent hashing&#26469;&#35774;&#35745;&#30456;&#24212;&#30340;&#33410;&#28857;&#22788;&#29702;&#21150;&#27861;&#12290;</p><h4>&#65288;1&#65289;&#26032;&#21152;&#20837;&#19968;&#20010;&#33410;&#28857;</h4><p>&#23558;&#26032;&#33410;&#28857;&#23384;&#22312;&#21521;&#20854;&#20182;&#33410;&#28857;&#20256;&#25773;&#65307;</p><p>&#24038;&#21491;&#30456;&#37051;&#33410;&#28857;&#24320;&#22987;&#21516;&#27493;&#22320;&#25913;&#21464;&#21508;&#33258;keys&#65292;replicas&#65307;</p><p>&#26032;&#21152;&#20837;&#33410;&#28857;&#24320;&#22987;&#20174;&#30456;&#37051;&#33410;&#28857;copy data&#65307;</p><p>&#26032;&#21152;&#20837;&#30340;&#33410;&#28857;&#20449;&#24687;&#24320;&#22987;&#20256;&#25773;&#21040;&#20854;&#20182;&#33410;&#28857;&#65307;</p><br /><p>Case1&#65306;&#22914;&#26524;&#22312;&#33410;&#28857;&#26032;&#21152;&#20837;&#30340;&#26102;&#20505;&#65292;&#36828;&#31163;&#36825;&#20010;node&#30340;&#20854;&#20182;node&#30340;membership view&#36824;&#27809;&#26377;&#26356;&#26032;&#65292;&#25152;&#20197;&#22312;&#36825;&#20010;&#26102;&#20505;&#65292;request&#36824;&#26159;&#20250;&#25351;&#21521;old node&#65307;&#20294;&#26159;&#22240;&#20026;new node&#30340;&#30456;&#37051;&#33410;&#28857;&#20449;&#24687;&#24050;&#32463;&#26356;&#26032;&#65292;&#20182;&#20204;&#20250;&#23558;request&#25351;&#21521;new node&#12290;</p><br /><p>Case2&#65306;&#22914;&#26524;&#26032;&#21152;&#20837;&#33410;&#28857;&#36824;&#22788;&#20110;data&#30340;&#26356;&#26032;&#29366;&#24577;&#20013;&#65292;&#36824;&#27809;&#26377;&#20934;&#22791;&#22788;&#29702;request&#65307;&#23601;&#38656;&#35201;&#29992;&#21040;vector clock&#26469;&#34920;&#26126;&#33258;&#36523;&#29366;&#24577;&#65292;client&#23601;&#20250;&#21435;&#35775;&#38382;&#20854;&#20182;replica&#12290;</p><h4>&#65288;2&#65289; &#33410;&#28857;&#31163;&#24320;&#25110;&#32773;&#23849;&#28291;</h4><p>Crashed node&#19981;&#20250;&#20877;&#22238;&#24212;neighbors&rsquo;&#30340;gossip &#20449;&#24687;&#12290;</p><p>Neighbor&#20250;&#26356;&#26032;membership&#20449;&#24687;&#65292;&#24182;&#24320;&#22987;asynchronously copy crashed node data&#12290;</p><img src="https://pic4.zhimg.com/9e5397e25e12f5f85e96df1b8be10c1b_b.png" width="636" alt="image" /><br /><p>&#19978;&#38754;&#28041;&#21450;&#21040;&#30340;&#33410;&#28857;&#37117;&#26159;VN&#65292;&#34394;&#25311;&#33410;&#28857;&#12290;&#22312;&#23454;&#38469;&#20013;&#36824;&#35201;&#23558;VN&#21644;PN&#32852;&#31995;&#36215;&#26469;&#12290;&#20998;&#37197;VN&#30340;&#26102;&#20505;&#65292;&#21407;&#21017;&#26159;&#23613;&#37327;&#36991;&#20813;VN &#30340; replicas&#23384;&#22312;&#30456;&#21516;&#30340;PN&#19978;&#38754;&#12290;&#26368;&#31616;&#21333;&#30340;&#23454;&#29616;&#26041;&#24335;&#23601;&#26159;&#65292;&#23558;VN&#38543;&#26426;&#20998;&#37197;&#21040;PN&#19978;&#38754;&#65292;&#21482;&#35201;&#30830;&#20445;PN&#19978;&#19981;&#21547;&#26377;&#30456;&#21516;key range&#30340;VN&#21363;&#21487;&#12290;</p><br /><p>&#24403;PN&#23849;&#28291;&#30340;&#26102;&#20505;&#65292;&#22810;&#20010;VN&#37117;&#20250;&#21516;&#26102;&#23849;&#28291;&#65292;&#20294;&#26159;&#22240;&#20026;VN&#30340;replicas&#38543;&#26426;&#20998;&#24067;&#22312;&#19981;&#21516;PN&#19978;&#38754;&#65292;&#36825;&#26679;&#22240;&#20026;crash&#24341;&#36215;&#30340;workload&#23601;&#20250;&#20998;&#24067;&#21040;&#22810;&#20010;PN&#19978;&#38754;&#12290;       	</p><h3>F. Client Consistency&#65288;&#19968;&#33268;&#24615;&#65289;</h3><p>&#24403;&#26377;&#20102;&#25968;&#25454;&#30340;&#24456;&#22810;&#22791;&#20221;&#20043;&#21518;&#65292;&#38656;&#35201;&#20851;&#24515;&#30340;&#38382;&#39064;&#23601;&#26159;&#22914;&#20309;&#22312;&#26426;&#22120;&#20043;&#38388;&#21516;&#27493;&#35753;&#29992;&#25143;&#26377;&#19968;&#20010;consistent view of the data&#12290;</p><br /><p>&#19968;&#33268;&#24615;&#27169;&#22411;&#26377;&#65306;</p><ul><li><p>Strict Consistency&#65288;one copy serializability&#65289;&#12290;</p></li><li><p>Read your write consistency: &#29992;&#25143;&#21487;&#20197;&#31435;&#39532;&#30475;&#21040;&#33258;&#24049;&#30340;update&#65292;&#20294;&#26080;&#27861;&#30475;&#21040;&#20854;&#20182;&#29992;  	&#25143;&#30340;&#26356;&#26032;&#12290;</p></li><li><p>Session Consistency: &#24403;&#29992;&#25143;&#30340;request&#22788;&#20110;&#19968;&#20010;session scope&#65288;&#19968;&#20010;server&#65289;&#19978;&#26102;&#65292;&#25552;&#20379;read your write consistency&#12290;</p></li><li><p>Monotonic read consistency: &#20445;&#35777;&#29992;&#25143;&#21482;&#20250;&#30475;&#21040;&#26368;&#26032;&#26356;&#26032;&#30340;data&#12290;</p></li><li><p>Eventual Consistency&#65306;&#65288;&#26368;&#32456;&#19968;&#33268;&#24615;&#65289;&#22312;&#26356;&#26032;&#36827;&#34892;&#20013;&#26102;&#65292;&#29992;&#25143;&#20250;&#30475;&#21040;&#19981;&#19968;&#33268;&#30340;update&#12290;&#36825;&#20010;model&#30340;&#20351;&#29992;&#24773;&#20917;&#26159;&#65292;&#23545;&#19968;&#20010;&#25968;&#25454;&#30340;concurrent&#20462;&#25913;&#22522;&#26412;&#19981;&#20250;&#21457;&#29983;&#65292;&#29992;&#25143;&#38656;&#35201;&#31561;&#19968;&#27573;&#26102;&#38388;&#25165;&#33021;&#30475;&#21040;&#20043;&#21069;&#30340;update&#12290;</p></li></ul><p>&#22312;&#30830;&#23450;Consistency Model&#20043;&#21518;&#65292;NoSQL&#22823;&#37096;&#20998;&#30340;&#24213;&#23618;&#26500;&#24314;&#23601;&#24050;&#32463;&#23436;&#25104;&#12290;&#26377;&#20102;&#30828;&#20214;&#37096;&#20998;&#65292;&#26377;&#20102;&#30828;&#20214;&#20043;&#38388;&#25277;&#35937;&#30340;&#26550;&#26500;&#65292;&#21487;&#26159;&#22312;&#20855;&#20307;&#20351;&#29992;&#20013;&#65292;&#36824;&#38656;&#35201;&#32473;&#20986;&#25968;&#25454;&#27969;&#21160;&#30340;&#26041;&#27861;&#12290;</p><p>&#35201;&#26681;&#25454;&#20855;&#20307;&#24773;&#20917;&#26469;&#36873;&#25321;&#22914;&#20309;&#23454;&#29616;&#19979;&#38754;&#20004;&#20010;&#38382;&#39064;&#65306;</p><ul><li><p>&#29992;&#25143;&#30340;request&#22914;&#20309;&#21040;&#36798;replicas&#65288;&#21103;&#26412;&#65289;</p></li><li><p>&#21103;&#26412;&#20043;&#38388;&#22914;&#20309;&#20256;&#25773;update</p></li></ul><h4>Master Slave Model&#65288;Single Master&#65289;</h4><img src="https://pic4.zhimg.com/58815be43ebae6a75dbbe3930a798ab7_b.png" width="795" alt="image" /><p>&#27599;&#19968;&#20010;PN&#37117;&#20250;&#26377;&#19968;&#20123;VN&#20316;&#20026;&#20998;&#24067;&#30340;master&#65292;&#32780;&#20854;&#20182;VN&#20316;&#20026;slaves&#12290;</p><br /><p>&#25152;&#26377;&#30340;&#35831;&#27714;&#37117;&#20250;&#32463;&#36807;Master&#26469;&#22788;&#29702;&#12290;&#20551;&#22914;Master&#22312;data &#26356;&#26032;&#30340;&#20256;&#36755;&#36807;&#31243;&#20013;crash&#30340;&#35805;&#65292;&#26377;&#21487;&#33021;&#36896;&#25104;&#25968;&#25454;&#20002;&#22833;&#12290;&#24403;Master crashed&#20043;&#21518;&#65292;&#26368;&#26032;&#26356;&#26032;&#30340;slave&#65288;VN&#65289;&#20250;&#34987;&#25552;&#21319;&#20026;&#26032;&#30340;master&#12290;</p><br /><p>&#35835;&#25805;&#20316;&#21487;&#20197;&#20998;&#21040;&#21508;&#20010;replicas&#19978;&#38754;&#12290;</p><br /><p>Single Master Model&#36866;&#29992;&#20110;&#26377;&#24456;&#22810;read&#25805;&#20316;&#30340;app&#65307;&#24403;update&#25805;&#20316;&#26159;&#24179;&#22343;&#20998;&#24067;&#22312;key range&#20043;&#20869;&#26102;&#65292;&#36825;&#20010;&#27169;&#22411;&#20063;&#21487;&#20197;&#32988;&#20219;&#12290;</p><p>&#28982;&#32780;&#20551;&#22914;&#22312;&#38190;&#30340;&#33539;&#22260;&#20869;&#20043;&#20869;&#65292;&#26377;&#19968;&#22359;&#21306;&#22495;&#21313;&#20998;&#27969;&#34892;&#23548;&#33268;&#26377;&#24456;&#22810;&#27425;&#30340;write&#25805;&#20316;&#30340;&#35805;&#65292;&#36825;&#20010;model&#23601;&#26080;&#27861;&#23558;workload&#24179;&#22343;&#20998;&#37197;&#12290;&#38024;&#23545;&#36825;&#31181;&#24773;&#20917;&#65292;&#23601;&#35201;&#24341;&#20837;&#26032;&#30340;model&#12290;</p><br /><h4>Multi-Master Model&#65288;No Master&#65289;</h4><p>&#27809;&#26377;master&#30340;&#24773;&#20917;&#19979;&#65292;&#22914;&#20309;&#20445;&#35777;consistency&#21602;&#65311;&#19968;&#31181;&#26041;&#27861;&#26159;&#65292;&#29992;&#20256;&#32479;&#30340;2PC protocol&#65292;&#22312;&#27599;&#27425;update&#30340;&#26102;&#20505;&#65292;&#23558;&#25152;&#26377;&#21103;&#26412;&#30340;&#29366;&#24577;&#37117;&#26356;&#26032;&#19968;&#27425;&#12290;&#22312;&#36825;&#31181;&#26041;&#27861;&#20013;&#65292;&#38656;&#35201;&#26377;&#19968;&#20010;coordinator&#26469;&#27807;&#36890;&#21508;&#20010;&#21103;&#26412;&#65292;&#35810;&#38382;&#27599;&#20010;&#21103;&#26412;&#26159;&#21542;ready&#65292;&#22914;&#26524;ready&#65292;coordinator&#38656;&#35201;&#21629;&#20196;&#25152;&#26377;&#21103;&#26412;&#25191;&#34892;commit&#25805;&#20316;&#65292;&#21103;&#26412;&#22312;&#23436;&#25104;&#25805;&#20316;&#20043;&#21518;&#35201;&#23558;&#32467;&#26524;&#20889;&#20837;log file&#12290;</p><p> &#19978;&#38754;&#36825;&#31181;&#26356;&#26032;&#25152;&#26377;&#21103;&#26412;&#30340;&#26041;&#27861;&#65292;&#26368;&#22823;&#30340;&#38382;&#39064;&#26159;&#65292;coordinator&#27809;&#26377;scalability&#65292;&#23427;&#38656;&#35201;&#22312;&#31561;&#24453;&#21508;&#20010;&#21103;&#26412;&#30830;&#35748;&#29366;&#24577;&#20043;&#21518;&#25165;&#33021;&#36827;&#34892;&#19979;&#19968;&#27493;&#25351;&#20196;&#65292;&#20250;&#32463;&#21382;&#22823;&#37327;&#30340;&#32593;&#32476;roundtrip&#20197;&#21450;disk I/O&#30340;&#24310;&#36831;&#12290;&#22914;&#26524;&#26377;&#19968;&#20010;&#21103;&#26412;&#22833;&#36133;&#30340;&#35805;&#65292;&#26356;&#26032;&#23601;&#22833;&#36133;&#12290;&#24403;&#26377;&#22823;&#37327;&#26426;&#22120;&#23384;&#22312;&#30340;&#26102;&#20505;&#65292;&#36825;&#31181;&#24773;&#20917;&#20250;&#32463;&#24120;&#21457;&#29983;&#12290;</p><h4>&#26356;&#39640;&#25928;&#30340;&#26041;&#24335;&#23601;&#26159;&#29992;Quorum Based 2PC&#65288;PAXOS&#65289;</h4><p>&#22312;&#36825;&#31181;model&#20013;&#65292;coordinator&#21482;&#38656;&#35201;&#26356;&#26032;W&#20010;&#21103;&#26412;&#65288;&#32780;&#19981;&#26159;&#20840;&#37096;&#30340;N&#20010;&#65289;&#65292;coordinator&#20381;&#28982;&#21487;&#20197;&#21521;&#25152;&#26377;N&#20010;&#21103;&#26412;&#20889;&#25805;&#20316;&#65292;&#21482;&#35201;&#24471;&#21040;&#20219;&#24847;W&#20010;&#21103;&#26412;&#22238;&#22797;&#30830;&#35748;&#21363;&#21487;&#12290;&#20174;&#27010;&#29575;&#30340;&#35282;&#24230;&#19978;&#65292;&#36825;&#26679;&#30340;&#26041;&#24335;&#26356;&#26377;&#25928;&#29575;&#12290;</p><p>&#22240;&#20026;&#19981;&#26159;&#25152;&#26377;&#30340;&#21103;&#26412;&#37117;&#34987;&#26356;&#26032;&#65288;W&#65289;&#65292;&#25152;&#20197;&#22312;&#35835;&#21462;&#25968;&#25454;&#30340;&#26102;&#20505;&#65292;&#19981;&#26159;&#35835;&#21462;&#19968;&#20010;&#21103;&#26412;&#65292;&#32780;&#26159;&#35201;&#35835;&#21462;R&#20010;&#65292;&#28982;&#21518;&#36873;&#21462;&#20854;&#20013;timestamp&#26368;&#26032;&#30340;&#37027;&#20010;&#12290;</p><br /><img src="https://pic2.zhimg.com/1184d834652da9f2ce2b7148473145a5_b.png" width="639" alt="image" /><p>Quorum Based 2PC &#24403;W=N&#65292; R=1&#30340;&#26102;&#20505;&#65292;&#23601;&#21464;&#25104;&#20102;&#20256;&#32479;&#30340;2PC&#26356;&#26032;&#26041;&#24335;&#12290;&#32780;W&#21644;R&#30340;&#21442;&#25968;&#36873;&#25321;&#65292;&#21017;&#21462;&#20915;&#20110;&#35774;&#35745;&#32773;&#23545;&#19968;&#33268;&#24615;&#30340;&#35201;&#27714;&#31243;&#24230;&#12290;</p><p>&#32780;&#22312;read&#25805;&#20316;&#20013;&#65292;&#22914;&#20309;&#24471;&#21040;&#21103;&#26412;&#30340;timestamp&#20449;&#24687;&#65292;&#20197;&#21450;&#22914;&#20309;&#27604;&#36739;timestamp&#65292;&#23601;&#38656;&#35201;&#29992;&#21040;vector clock &#36825;&#20010;&#25216;&#26415;&#20102;&#12290;</p><h4>Gossip</h4><p>&#22914;&#26524;&#29992;&#25143;&#21487;&#20197;&#25509;&#21463;&#26356;&#21152;&#24369;&#30340;&#19968;&#33268;&#24615;&#30340;&#35805;&#65292;&#38500;&#20102;Quorum Based 2PC&#20043;&#22806;&#65292;&#36824;&#21487;&#20197;&#20351;&#29992;Gossip &#36825;&#31181;protocol&#26469;&#22312;&#21508;&#20010;replicas&#20043;&#38388;&#20256;&#36882;&#20449;&#24687;&#12290;</p><br /><p>&#23427;&#24120;&#29992;&#20110;P2P&#30340;&#36890;&#20449;&#21327;&#35758;&#65292;&#36825;&#20010;&#21327;&#35758;&#23601;&#26159;&#27169;&#25311;&#20154;&#31867;&#20013;&#20256;&#25773;&#35875;&#35328;&#30340;&#34892;&#20026;&#32780;&#26469;&#12290;&#31616;&#21333;&#30340;&#25551;&#36848;&#19979;&#36825;&#20010;&#21327;&#35758;&#65292;&#39318;&#20808;&#35201;&#20256;&#25773;&#35875;&#35328;&#23601;&#35201;&#26377;&#31181;&#23376;&#33410;&#28857;&#12290;&#31181;&#23376;&#33410;&#28857;&#27599;&#31186;&#37117;&#20250;&#38543;&#26426;&#21521;&#20854;&#20182;&#33410;&#28857;&#21457;&#36865;&#33258;&#24049;&#25152;&#25317;&#26377;&#30340;&#33410;&#28857;&#21015;&#34920;&#65292;&#20197;&#21450;&#38656;&#35201;&#20256;&#25773;&#30340;&#28040;&#24687;&#12290;&#20219;&#20309;&#26032;&#21152;&#20837;&#30340;&#33410;&#28857;&#65292;&#23601;&#22312;&#36825;&#31181;&#20256;&#25773;&#26041;&#24335;&#19979;&#24456;&#24555;&#22320;&#34987;&#20840;&#32593;&#25152;&#30693;&#36947;&#12290;&#36825;&#20010;&#21327;&#35758;&#30340;&#31070;&#22855;&#23601;&#22312;&#20110;&#23427;&#20174;&#35774;&#35745;&#24320;&#22987;&#23601;&#27809;&#24819;&#21040;&#20449;&#24687;&#19968;&#23450;&#35201;&#20256;&#36882;&#32473;&#25152;&#26377;&#30340;&#33410;&#28857;&#65292;&#20294;&#26159;&#38543;&#30528;&#26102;&#38388;&#30340;&#22686;&#38271;&#65292;&#22312;&#26368;&#32456;&#30340;&#26576;&#19968;&#26102;&#21051;&#65292;&#20840;&#32593;&#20250;&#24471;&#21040;&#30456;&#21516;&#30340;&#20449;&#24687;&#12290;</p><img src="https://pic3.zhimg.com/cde5fd627bf0c48c879c300f93aba97e_b.png" width="483" alt="image" /><h3>G. &#23384;&#20648;&#30340;&#20855;&#20307;&#23454;&#29616;</h3><p>&#19968;&#31181;&#23454;&#29616;&#26041;&#24335;&#26159;&#35753;&#25968;&#25454;&#30340;&#23384;&#20648;pluggable&#65292;MySQL&#65292;Filesystem&#65292;&#25110;&#32773;&#19968;&#20010;&#24040;&#22823;&#30340;Hashtable&#37117;&#21487;&#20197;&#29992;&#20316;&#23384;&#20648;&#30340;&#26426;&#21046;&#12290;</p><br /><p>&#21478;&#19968;&#31181;&#26041;&#24335;&#26159;&#65292;&#37319;&#29992;&#39640;&#21487;&#25193;&#23637;&#24615;&#30340;&#23384;&#20648;&#12290;&#20855;&#20307;&#30340;&#32454;&#33410;&#21487;&#20197;&#32487;&#32493;&#38405;&#35835;CouchDB &#36824;&#26377; Google BigTable &#30340;&#30456;&#20851;&#25991;&#29486;&#65292;&#22312;&#36825;&#37324;&#23601;&#31616;&#21333;&#20171;&#32461;&#19968;&#20010;&#22312;&#23454;&#29616;&#23384;&#20648;&#20013;&#29992;&#21040;&#30340;&#25216;&#26415;&#12290;</p><br /><p>Copy-on-modifed approach&#65306;</p><img src="https://pic1.zhimg.com/ece5b54824bc978dee69c1ae76f37aa8_b.png" width="614" alt="image" /><br /><p>&#20219;&#20309;&#19968;&#20010;&#26356;&#26032;&#37117;&#20250;&#20135;&#29983;&#19968;&#20010;&#22791;&#20221;&#65292;&#36827;&#32780;&#24433;&#21709;&#20854;&#32034;&#24341;&#23548;&#33268;&#32034;&#24341;&#34987;&#20462;&#25913;&#21518;&#28982;&#21518;&#32034;&#24341;&#20063;&#20250;&#20135;&#29983;&#19968;&#20010;&#22791;&#20221;&#65292;&#36825;&#26679;&#19968;&#30452;&#24448;&#22797;&#19979;&#21435;&#30452;&#21040;&#26681;&#32034;&#24341;&#12290;</p><h1>NoSQL&#30340;&#24635;&#32467;</h1><p>&#20854;&#23454;NoSQL&#30340;&#27010;&#24565;&#24456;&#22823;&#65292;&#25152;&#26377;&#19981;&#26159;RDBMS&#30340;&#23384;&#20648;&#31995;&#32479;&#37117;&#21487;&#20197;&#21483;&#20570;NoSQL&#12290;&#19978;&#38754;&#20171;&#32461;&#30340;NoSQL&#20027;&#35201;&#26159;&#20026;&#20102;&#24212;&#23545;Scalability&#32780;&#20135;&#29983;&#30340;&#19968;&#31181;&#35299;&#20915;&#26041;&#26696;&#12290;&#22312;&#38405;&#35835;&#23436;&#36825;&#31687;&#25991;&#31456;&#20043;&#21518;&#65292;&#23545;&#20110;&#22914;&#20309;&#35299;&#20915;2&#20013;&#30340;&#38382;&#39064;&#65292;&#20063;&#23601;&#26377;&#20102;&#26041;&#27861;&#21644;&#27493;&#39588;&#65306;</p><ul><li><p>Partition Data&#65292;&#23558;data&#23384;&#22312;&#19981;&#21516;&#30340;&#26426;&#22120;&#19978;&#65292;balance work load&#65288;consistent hashing&#65289;</p></li><li><p>&#19975;&#19968;&#20854;&#20013;&#26377;&#26426;&#22120;&#22351;&#25481;&#24590;&#20040;&#21150;&#65311;how to handle failure&#65288;copy to neighbors&#65289;</p></li><li><p>&#22914;&#20309;&#22312;&#26426;&#22120;&#20043;&#38388;&#22791;&#20221;&#25968;&#25454;&#65292;&#20570;replica&#65288;Master or NoMaster model&#65289;</p></li><li><p>&#22312;&#25968;&#25454;&#22791;&#20221;&#30340;&#26102;&#20505;&#65292;&#22914;&#20309;&#20445;&#25345;&#21516;&#27493;&#21602;&#65311;Synchronization&#65288;PAXOS&#65292; Gossip&#65289;</p></li><li><p>&#22240;&#20026;&#26426;&#22120;&#25968;&#37327;&#21487;&#21464;&#65292;&#24403;&#20219;&#21153;&#37327;&#21464;&#21270;&#23548;&#33268;&#26426;&#22120;&#25968;&#37327;&#21464;&#21270;&#30340;&#26102;&#20505;&#65292;&#21448;&#22914;&#20309;&#37325;&#26032;&#20998;&#37197;&#25968;&#25454;&#21602;&#65288;VN&#30340;&#21152;&#20837;&#21644;&#31163;&#24320;&#65289;</p></li></ul><p>&#20197;&#19978;&#23601;&#26159;NoSQL&#30340;&#19968;&#20123;&#22522;&#26412;&#27010;&#24565;&#65292;&#22312;&#25484;&#25569;&#36825;&#20123;&#20043;&#21518;&#65292;&#38405;&#35835;Dynamo&#25110;&#32773;Canssandra&#26102;&#65292;&#23601;&#20250;&#26356;&#21152;&#30340;&#26377;&#26041;&#21521;&#24863;&#12290;&#20063;&#23601;&#20250;&#26126;&#30333;&#36825;&#31181;&#25216;&#26415;&#20026;&#20160;&#20040;&#23545;&#20110;&#20687;Facebook&#36825;&#26679;&#22823;&#22411;&#20844;&#21496;&#30340;&#25104;&#21151;&#33267;&#20851;&#37325;&#35201;&#20102;&#12290;</p><br />&#21442;&#32771;&#36164;&#26009;&#65306;<br /><br /><a href="https://link.zhihu.com/?target=http%3A//horicky.blogspot.com/2009/11/nosql-patterns.html" target="_blank">http://horicky.blogspot.com/2009/11/nosql-patterns.html<i></i></a><br /><br /><a href="https://link.zhihu.com/?target=http%3A//horicky.blogspot.com/2010/10/bigtable-model-with-cassandra-and-hbase.html" target="_blank">http://horicky.blogspot.com/2010/10/bigtable-model-with-cassandra-and-hbase.html<i></i></a><br /><br /><a href="https://link.zhihu.com/?target=http%3A//www.oracle.com/technetwork/cn/articles/cloudcomp/berkeleydb-nosql-323570-zhs.html" target="_blank">http://www.oracle.com/technetwork/cn/articles/cloudcomp/berkeleydb-nosql-323570-zhs.html<i></i></a><br /><br /><a href="https://link.zhihu.com/?target=https%3A//www.quora.com/What-is-the-difference-between-gossip-and-Paxos-protocols" target="_blank">https://www.quora.com/What-is-the-difference-between-gossip-and-Paxos-protocols<i></i></a><br /><br /><a href="https://link.zhihu.com/?target=http%3A//blog.csdn.net/cloudresearch/article/details/23127985" target="_blank">http://blog.csdn.net/cloudresearch/article/details/23127985<i></i></a><br /><br /><a href="https://link.zhihu.com/?target=https%3A//www.quora.com/Why-use-Vector-Clocks-in-a-distributed-database" target="_blank">https://www.quora.com/Why-use-Vector-Clocks-in-a-distributed-database<i></i></a><br /><br /><br /><br /><p>&#26412;&#25991;&#20316;&#32773;&#65306;Zhang Y&#65292;&#26356;&#22810;&#31934;&#24425;&#20869;&#23481;&#65292;&#27426;&#36814;&#35775;&#38382;&#23448;&#32593; <a href="https://link.zhihu.com/?target=http%3A//BitTiger.io">http://BitTiger.io</a> &#25110;&#20851;&#27880; &ldquo;&#35770;&#30721;&#20892;&#30340;&#33258;&#25105;&#20462;&#20859;&rdquo; &#24494;&#20449;&#20844;&#20247;&#21495;&#65306;bit_tiger</p>
<br /><br />
&#26469;&#28304;&#65306;&#30693;&#20046; www.zhihu.com<br />
    
&#20316;&#32773;&#65306;<a href="http://www.zhihu.com/people/chen-tian-57-75?utm_campaign=rss&amp;utm_medium=rss&amp;utm_source=rss&amp;utm_content=author">Evelyn Shen</a><br /><br />
&#12304;&#30693;&#20046;&#26085;&#25253;&#12305;&#21315;&#19975;&#29992;&#25143;&#30340;&#36873;&#25321;&#65292;&#20570;&#26379;&#21451;&#22280;&#37324;&#30340;&#26032;&#40092;&#20107;&#20998;&#20139;&#22823;&#29275;&#12290;
        <a href="http://daily.zhihu.com/?utm_source=rssyanwenzi&amp;utm_campaign=tuijian&amp;utm_medium=rssnormal" target="_blank">&#28857;&#20987;&#19979;&#36733;</a><br /><p><strong>Full Text RSS extracting error</strong></p></body></html>